/**
 * (C) Sergey Orshanskiy,2014.
 * The frontend side of the ForeverTodo application for managing lists of todo items.
 */
if(typeof $=="undefined"){throw"jQuery is not loaded"}FOREVER_TODO_JS=function(e,t){function o(t){s=i+t+"/";e.ajax({cache:false,url:r+"?limit=999999",dataType:"json",success:function(e){var t=document.createDocumentFragment();n={};for(var r=0,i=e.objects.length;r<i;r++){var s=e.objects[r];if(s.expires){s.expires=new Date(s.expires)}n[s.id]=s;var o=document.createElement("li");o.setAttribute("data-pk",s.id);o.innerHTML=m(s.id,s.title,s.text,s.priority,s.completed);t.appendChild(o)}document.getElementById("main_item_list").appendChild(t);w();S();for(var r=0,i=e.objects.length;r<i;r++){d(e.objects[r].id)}},error:function(e,t,n){alert("We are so sorry! Loading your items failed: "+n+". You can try to refresh the page or come back later.");throw"getAllItems failed: "+n+", "+e.status}})}function u(t){e.ajax({type:"DELETE",url:r+t+"/",success:function(r,i,s){delete n[t];var o=e("#todo-item-"+t);o.find("*").unbind().prop("disabled",true);o.fadeOut("slow",function(){o.remove()})},error:function(e,t,n){alert("We are so sorry! Delete unexpectedly failed: "+n);throw"Delete failed: "+n+", "+e.status}})}function a(t,i,s,o,u,a){e.ajax({type:"PUT",url:r+t+"/",data:p({name:i,value:s,pk:t}),contentType:"application/json",success:function(e,r,s){n[t][i]=o;u()},error:function(e,t,n){alert("We are so sorry! Update unexpectedly failed: "+n);a();throw"Update failed: "+n+", "+e.status}})}function f(t){t.user=s;var i=JSON.stringify(t);var o;e.ajax({type:"POST",url:r,data:i,success:function(r,i,s){var u=s.getResponseHeader("Location");var a=u.split("/");o=parseInt(a[a.length-2]);if(isNaN(o)){throw"Error while parsing "+u+" to get item id"}else if(o in n){throw"Server returned duplicate item id "+o+" for a new element"}else{n[o]=t;var f=document.createElement("li");f.setAttribute("data-pk",o);f.innerHTML=m(o,t.title,t.text,t.priority,t.completed);f.style.display="none";var l=document.getElementById("main_item_list");l.insertBefore(f,l.firstChild);e(f).fadeIn("slow");d(o)}},error:function(e,t,n){alert("We are so sorry! Create unexpectedly failed: "+n);throw"Create failed: "+n+", "+e.status},contentType:"application/json"})}function l(e,r){var i=["label-default","label-primary","label-danger"][r];var s=["Low priority","Normal priority","High priority"][r];var o=!n[e].completed;return"<button "+(o?"":" disabled ")+' type="button" class="btn '+i+'" id="btn-priority-'+e+'" priority='+r+' onclick="'+t+".toggleItemPriority("+e+', true); ">'+s+"</button>"}function c(e,t){h(e,(n[e].priority+1)%3)}function h(t,n){a(t,"priority",n,n,function(){e("#btn-priority-"+t).replaceWith(l(t,n))},function(){})}function p(e){var t={};var r=n[e.pk];for(prop in r){t[prop]=r[prop]}t[e.name]=e.value;return JSON.stringify(t)}function d(t){var i=e("#todo-item-"+t);i.find(".todo-header").editable({url:r+t+"/",name:"title",params:p,success:function(e,r){n[t]["title"]=r},error:function(e,t){return"Edit unexpectedly failed: "+e.statusText}});i.find(".todo-content").editable({url:r+t+"/",name:"text",params:p,success:function(e,r){n[t]["text"]=r},error:function(e,t){return"Edit unexpectedly failed: "+e.statusText}});var s=n[t].expires;var o=i.find(".datepicker").pickadate({clear:"Never expires"}).pickadate("picker").clear();if(s!=undefined){o.set("select",s)}if(!n[t].completed){function u(e){var r=e.select!=undefined?(new Date(e.select)).toUTCString():null;var i=e.select!=undefined?new Date(e.select):null;console.log("Modifying date, new: "+r+", item_id="+t);a(t,"expires",r,i,function(){},function(){var e=n[t].expires;if(e){o.set("select",e,{muted:true})}else{o.off("set");o.clear();o.on("set",u)}})}o.on("set",u)}else{o.stop()}}function v(t,r){a(t,"completed",r,r,function(){var r=n[t];e("#todo-item-"+t).replaceWith(m(t,r.title,r.text,r.priority,r.completed));d(t)},function(){})}function m(e,n,r,i,s){return(s?'<div class="todo-item panel panel-success" id="todo-item-'+e+'">':'<div class="todo-item panel panel-default"               id="todo-item-'+e+'">')+'<div class="panel-heading">'+(s?'<span class="label label-success">Completed</span>':'<span class="label label-default">Pending</span>')+l(e,i)+"<u "+(s?"":'class="todo-header"')+'data-type="text" data-pk="'+e+'">'+'<b class="panel-title" >'+n+"</b></u>"+(s?"<em>(not editable any more)</em>":"<em>(click or tap to edit)</em>")+"</div>"+'<div class="panel-body '+(s?"":" todo-content ")+'" data-type="textarea" data-pk="'+e+'">'+r+"</div>"+'<div class="panel-footer" style="position: relative">'+(s?'<button type="button" class="btn btn-sm"    onclick="'+t+".markCompleted("+e+', false);">Revert to pending</button>':'<button type="button" class="btn btn-success" onclick="'+t+".markCompleted("+e+', true);">Mark as completed</button>')+'&nbsp;Item expires: <input type="text" class="datepicker" autocomplete="off" '+(s?" disabled=true ":"")+" /><em>"+(s?"(not editable any more)":"(click or tap to edit)")+"</em>"+'<button type="button" class="btn btn-warning pull-right" onclick="'+t+".ajax_deleteItem_async("+e+');" >Delete</button>'+"</div></div>"}function g(){var e={title:"New item: Enter the title.",text:"New item: Enter the description of the item.",priority:0,expires:null,completed:false};f(e)}function y(){return e("#main_item_list").find("li")}function b(e,t){if(!t){return function(t,r){var i=n[t.e.attr("data-pk")][e];var s=n[r.e.attr("data-pk")][e];return i==s?0:i>s?1:-1}}else{return function(t,r){var i=n[t.e.attr("data-pk")][e];var s=n[r.e.attr("data-pk")][e];if(!i){return!s?0:1}if(!s){return!i?0:-1}return i==s?0:i>s?1:-1}}}function w(){y().tsort(".datepicker",{sortFunction:b("title",false)});}function E(){y().tsort(".datepicker",{sortFunction:b("priority",false)});}function S(){y().tsort(".datepicker",{sortFunction:b("expires",true)});}var n={};e(function(){e.fn.editable.defaults.ajaxOptions={type:"PUT",contentType:"application/json"};e.fn.editable.defaults.mode="inline"});var r="/api/v1/todo/";var i="/api/v1/user/";var s=undefined;return{init:o,onCreateNewItem:g,markCompleted:v,ajax_deleteItem_async:u,toggleItemPriority:c,uiSortByTitle:w,uiSortByPriority:E,uiSortByDate:S}}($,"FOREVER_TODO_JS")